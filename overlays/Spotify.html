<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>tawmae - SPOTIFY & SB Overlay</title>
    <link id="fontLink" href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/@streamerbot/client/dist/streamerbot-client.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
        }
        #songOverlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1100px;
            border-radius: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            visibility: hidden;
            transition: visibility 1s ease;
            overflow: hidden;
        }
        #songOverlay.visible {
            visibility: visible;
        }
        #songOverlayBackground {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 20px;
            pointer-events: none;
            transition: opacity 1s ease;
        }
        #songOverlayContent {
            position: relative;
            z-index: 1;
            display: flex;
            width: 100%;
            color: #fff;
            transition: opacity 1s ease;
        }
        #coverImageContainer {
            position: relative;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #coverImage {
            display: block;
            max-width: 100%;
            height: auto;
            border-radius: 20px;
            object-fit: cover;
        }
        #remainingTime {
            position: absolute;
            background: rgba(0,0,0,0.7);
            border-radius: 10px;
            color: #fff;
            transition: opacity 1s ease;
        }
        #songDetails {
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex: 1;
            text-align: left;
            transition: opacity 1s ease;
        }
        #artists {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        #trackName {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        #requestedByContainer {
            display: flex;
            align-items: center;
            color: #ccc;
            transition: opacity 1s ease;
        }
        #requestedByText {
            margin-right: 10px;
        }
        #userProfileImage {
            border-radius: 50%;
            object-fit: cover;
            transition: opacity 1s ease;
        }

        #progressBarContainer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 0 0 20px 20px;
            overflow: hidden;
            transition: opacity 1s ease;
        }
        #progressBar {
            background: #fff;
            opacity: 0.7;
            transition: width 0.5s linear;
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="songOverlay" class="hidden">
        <div id="songOverlayBackground"></div>
        <div id="songOverlayContent">
            <div id="coverImageContainer">
                <img id="coverImage" src="" alt="Cover Image">
                <div id="remainingTime"></div>
            </div>
            <div id="songDetails">
                <div id="artists"></div>
                <div id="trackName"></div>
                <div id="requestedByContainer">
                    <span id="requestedByText"></span>
                    <img id="userProfileImage" src="" alt="User Profile Image">
                </div>
            </div>
            <div id="progressBarContainer">
                <div id="progressBar"></div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        const params = new URLSearchParams(window.location.search)
        const port = params.get('port') || '8080'
        const adress = params.get('adress') || '127.0.0.1'
        const password = params.get('password') || ''
        const backgroundcolor = params.get('backgroundcolor') || 'linear-gradient(135deg, #2a2a2a 0%, #3b3b3b 100%)'
        const fontcolor = params.get('fontcolor') || '#fff'
        const font = params.get('font') || 'Poppins'
        const progressbarcolor = params.get('progressbarcolor') || '#fff'
        const alwayson = params.get('alwayson') !== 'false'
        const opacityParam = parseInt(params.get('opacity') || '100')
        const dropshadowParam = params.get('dropshadow') === 'true'
        const fontsizeParam = parseInt(params.get('fontsize') || '56')
        const widthParam = parseInt(params.get('width') || '900')
        let progressbarParam = params.get('progressbar')
        if (!progressbarParam) {
            progressbarParam = 'true'
        }

        if (font !== 'Poppins') {
            const link = document.createElement('link')
            link.href = `https://fonts.googleapis.com/css2?family=${encodeURIComponent(font)}&display=swap`
            link.rel = 'stylesheet'
            document.head.appendChild(link)
            document.body.style.fontFamily = `${font}, sans-serif`
        }

        const client = new StreamerbotClient({
            host: adress,
            port: parseInt(port),
            endpoint: '/',
            password: password,
            onConnect
        })

        const songOverlay = document.getElementById('songOverlay')
        const songOverlayBackground = document.getElementById('songOverlayBackground')
        const songOverlayContent = document.getElementById('songOverlayContent')
        const coverImageContainer = document.getElementById('coverImageContainer')
        const coverImage = document.getElementById('coverImage')
        const remainingTime = document.getElementById('remainingTime')
        const artistsEl = document.getElementById('artists')
        const trackNameEl = document.getElementById('trackName')
        const requestedByText = document.getElementById('requestedByText')
        const userProfileImage = document.getElementById('userProfileImage')
        const progressBar = document.getElementById('progressBar')
        const progressBarContainer = document.getElementById('progressBarContainer')

        songOverlay.style.width = widthParam + 'px'
        songOverlayBackground.style.background = backgroundcolor
        songOverlayBackground.style.opacity = (opacityParam / 100).toString()
        songOverlayContent.style.color = fontcolor
        progressBar.style.background = progressbarcolor

        if (opacityParam === 100) {
            songOverlay.style.boxShadow = '0 8px 16px rgba(0, 0, 0, 0.3)'
        } else {
            songOverlay.style.boxShadow = 'none'
        }

        if (progressbarParam === 'false') {
            progressBarContainer.style.display = 'none'
        } else {
            progressBarContainer.style.display = 'block'
        }

        function setFontSizes(baseSize) {
            const ratio = baseSize / 56
            trackNameEl.style.fontSize = `${baseSize}px`
            artistsEl.style.fontSize = `${Math.round(baseSize * (44/56))}px`
            requestedByText.style.fontSize = `${Math.round(baseSize * (26/56))}px`
            remainingTime.style.fontSize = `${Math.round(baseSize * (24/56))}px`

            const newPadding = Math.round(20 * ratio)
            songOverlayContent.style.padding = `${newPadding}px`
            coverImageContainer.style.marginRight = `${Math.round(20 * ratio)}px`
            progressBarContainer.style.height = `${Math.round(10 * ratio)}px`

            const coverSize = Math.round(200 * ratio)
            coverImageContainer.style.width = coverSize + 'px'
            coverImageContainer.style.height = coverSize + 'px'

            const timeOffset = Math.round(10 * ratio)
            remainingTime.style.bottom = timeOffset + 'px'
            remainingTime.style.right = timeOffset + 'px'
            remainingTime.style.padding = `${Math.round(3 * ratio)}px ${Math.round(5 * ratio)}px`
        }

        function applyDropShadow() {
            const shadowValue = '2px 2px 2px rgba(0,0,1,1)'
            artistsEl.style.textShadow = shadowValue
            trackNameEl.style.textShadow = shadowValue
            requestedByText.style.textShadow = shadowValue
            remainingTime.style.textShadow = shadowValue
        }

        setFontSizes(fontsizeParam)

        if (dropshadowParam) {
            applyDropShadow()
        }

        let currentCoverUrl = ''
        let inactivityTimeout = null
        let lastTrackId = null
        let lastIsRequested = null

        function onConnect() {}

        client.on('Misc.GlobalVariableUpdated', ({ data }) => {
            if (data.name === 'tawmae_SPOTIFY_AND_SB_INFO') {
                try {
                    const parsedData = typeof data.newValue === 'string' ? JSON.parse(data.newValue) : data.newValue
                    updateSongInfo(parsedData)
                } catch (e) {}
            }
        })

        function updateSongInfo(data) {
            resetInactivityTimeout()
            if (data.songInfo && data.songInfo.isPlaying) {
                const songInfo = data.songInfo
                const isNewTrack = songInfo.trackId !== lastTrackId
                const isRequestedChanged = songInfo.isRequested !== lastIsRequested
                if (isNewTrack || isRequestedChanged) {
                    lastTrackId = songInfo.trackId
                    lastIsRequested = songInfo.isRequested
                    fadeOutContent().then(() => {
                        updateContent(songInfo)
                        fadeInContent()
                        songOverlay.classList.add('visible')
                    })
                } else {
                    updateDynamicContent(songInfo)
                }
            } else {
                songOverlay.classList.remove('visible')
                lastTrackId = null
                lastIsRequested = null
            }
        }

        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text
        }

        function updateContent(songInfo) {
            if (songInfo.coverImageUrl && songInfo.coverImageUrl !== currentCoverUrl) {
                coverImage.src = songInfo.coverImageUrl
                currentCoverUrl = songInfo.coverImageUrl
            }
            artistsEl.textContent = truncateText(songInfo.artists || 'Unknown', 25)
            trackNameEl.textContent = truncateText(songInfo.trackName || 'Unknown', 25)

            if (songInfo.isRequested && songInfo.user) {
                requestedByText.textContent = `requested by ${songInfo.user}`
                userProfileImage.src = songInfo.userProfileImageUrl
                userProfileImage.style.display = 'block'
            } else {
                requestedByText.textContent = ''
                userProfileImage.src = ''
                userProfileImage.style.display = 'none'
            }

            updateDynamicContent(songInfo)
        }

        function updateDynamicContent(songInfo) {
            const remainingMs = songInfo.durationMs - songInfo.progressMs
            const remainingSeconds = Math.floor((remainingMs / 1000) % 60)
            const remainingMinutes = Math.floor((remainingMs / (1000 * 60)) % 60)
            remainingTime.textContent = `${remainingMinutes}:${remainingSeconds.toString().padStart(2, '0')}`

            const remainingPercentage = (remainingMs / songInfo.durationMs) * 100
            if (progressbarParam !== 'false') {
                progressBar.style.width = `${remainingPercentage}%`
            }
        }

        function fadeOutContent() {
            return new Promise((resolve) => {
                coverImageContainer.style.opacity = '0'
                songDetails.style.opacity = '0'
                requestedByText.style.opacity = '0'
                userProfileImage.style.opacity = '0'
                remainingTime.style.opacity = '0'
                setTimeout(() => {
                    resolve()
                }, 1000)
            })
        }

        function fadeInContent() {
            coverImageContainer.style.opacity = '1'
            songDetails.style.opacity = '1'
            requestedByText.style.opacity = '1'
            userProfileImage.style.opacity = '1'
            remainingTime.style.opacity = '1'
        }

        function resetInactivityTimeout() {
            if (inactivityTimeout) {
                clearTimeout(inactivityTimeout)
            }
            inactivityTimeout = setTimeout(() => {
                if (!alwayson) {
                    songOverlay.classList.remove('visible')
                }
            }, 30000)
        }

        if (!alwayson) {
            resetInactivityTimeout()
        }
    </script>
</body>
</html>
