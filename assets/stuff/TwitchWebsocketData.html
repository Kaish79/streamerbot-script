<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch WebSocket Event Grabber</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Fira+Code:wght@400&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@iconify/iconify@2.2.1/dist/iconify.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', Arial, sans-serif;
            margin: 20px;
            background-color: #121212;
            color: #ffffff;
            line-height: 1.6;
        }

        h1 {
            font-weight: 600;
        }

        .title-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .title-container img {
            width: 60px;
            height: 60px;
        }

        .button-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #connectBtn {
            background-color: #4caf50;
            color: #ffffff;
        }

        #connectBtn:hover {
            background-color: #45a049;
        }

        #disconnectBtn {
            background-color: #f44336;
            color: #ffffff;
        }

        #disconnectBtn:hover {
            background-color: #d32f2f;
        }

        label {
            font-size: 14px;
        }

        #addressInput,
        #portInput {
            padding: 8px;
            font-size: 14px;
            border-radius: 5px;
            border: 1px solid #555;
            width: 100px;
            background-color: #1e1e1e;
            color: #ffffff;
        }

        #output {
            border: 1px solid #333;
            padding: 15px;
            height: calc(100vh - 200px);
            overflow-y: auto;
            background-color: #1e1e1e;
            border-radius: 5px;
            font-size: 14px;
        }

        .message {
            font-family: 'Fira Code', monospace;
            padding: 8px;
            border-radius: 3px;
            margin-bottom: 10px;
            position: relative;
        }

        .incoming {
            background-color: #2e7d32;
            color: #ffffff;
        }

        .outgoing {
            background-color: #1565c0;
            color: #ffffff;
        }

        .error {
            background-color: #b71c1c;
            color: #ffffff;
        }

        .message-header {
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .arrow {
            font-size: 18px;
            margin-right: 10px;
            display: inline-flex;
            align-items: center;
        }

        .timestamp {
            font-size: 12px;
            color: #aaa;
            background-color: #333;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: 'Fira Code', monospace;
            margin-right: 10px;
        }

        .message-body {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #333;
            border-radius: 3px;
        }

        .expanded .message-body {
            display: block;
        }

        .copy-button {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 18px;
            color: #fff;
            cursor: pointer;
        }

        .copy-button:hover {
            color: #ddd;
        }

        #copyIndicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #copyIndicator.show {
            display: block;
            opacity: 1;
        }

        #downloadLogBtn {
            margin-left: 20px;
            background-color: #3f51b5;
            color: #ffffff;
        }

        #downloadLogBtn:hover {
            background-color: #303f9f;
        }
    </style>
</head>

<body>
    <div class="title-container">
        <h1>Streamer.bot WS Event Grabber for Twitch</h1>
        <img src="https://cdn.7tv.app/emote/01F6FTE8B80008E39HFFQJ7MWS/4x.webp" alt="Animated Image">
    </div>
    <div class="button-container">
        <button id="connectBtn">Connect</button>
        <button id="disconnectBtn" disabled>Disconnect</button>
        <label for="addressInput">Address:</label>
        <input id="addressInput" type="text" value="localhost" placeholder="Address">
        <label for="portInput">Port:</label>
        <input id="portInput" type="number" value="8080" placeholder="Port">
        <label>
            <input type="checkbox" id="excludeChatCheckbox" checked>
            Exclude Chat Message Events
        </label>
        <button id="downloadLogBtn">Download Log</button>
    </div>
    <div id="output"></div>
    <div id="copyIndicator">Copied to clipboard</div>

    <script>
        let ws;
        const output = document.getElementById("output");
        const connectBtn = document.getElementById("connectBtn");
        const disconnectBtn = document.getElementById("disconnectBtn");
        const addressInput = document.getElementById("addressInput");
        const portInput = document.getElementById("portInput");
        const copyIndicator = document.getElementById("copyIndicator");
        const excludeChatCheckbox = document.getElementById("excludeChatCheckbox");
        const downloadLogBtn = document.getElementById("downloadLogBtn");

        let eventLog = [];

        function logMessage(message, type = "incoming") {
            let headerText = "Unknown";
            let bodyText = JSON.stringify(message, null, 2);
            let timestamp = new Date().toLocaleTimeString();

            try {
                const json = JSON.parse(message);

                if (excludeChatCheckbox.checked && json.event?.type === "ChatMessage") return;

                if (json.request === "Hello") {
                    headerText = `Hello - ${json.info.name} - ${json.info.version}`;
                } else if (json.status === "ok" && json.id === "Poggers") {
                    headerText = "Status: Ok";
                } else if (json.event && json.event.source && json.event.type) {
                    headerText = `${json.event.source} - ${json.event.type}`;
                } else if (message === "WebSocket connection closed.") {
                    headerText = "WebSocket connection closed.";
                } else {
                    headerText = message.slice(0, 50);
                }

                bodyText = JSON.stringify(json, null, 2);


                eventLog.push(`[${timestamp}] ${headerText}\n${bodyText}\n`);
            } catch {
                if (message === "WebSocket connection closed.") {
                    headerText = "WebSocket connection closed.";
                } else if (type === "error") {
                    headerText = "Error";
                } else if (type === "outgoing") {
                    headerText = message;
                }


                eventLog.push(`[${timestamp}] ${headerText}\n${message}\n`);
            }

            const div = document.createElement("div");
            div.className = `message ${type}`;

            const arrow = document.createElement("span");
            arrow.className = "arrow";
            arrow.innerHTML = `<span class="iconify" data-icon="material-symbols-light:keyboard-double-arrow-right-rounded"></span>`;

            const header = document.createElement("div");
            header.className = "message-header";
            header.appendChild(arrow);

            const timeSpan = document.createElement("span");
            timeSpan.className = "timestamp";
            timeSpan.textContent = timestamp;
            header.appendChild(timeSpan);

            header.appendChild(document.createTextNode(headerText));

            header.addEventListener("click", () => {
                div.classList.toggle("expanded");
                const icon = arrow.querySelector(".iconify");
                icon.setAttribute(
                    "data-icon",
                    div.classList.contains("expanded")
                        ? "material-symbols-light:keyboard-double-arrow-down-rounded"
                        : "material-symbols-light:keyboard-double-arrow-right-rounded"
                );
            });

            div.appendChild(header);

            const body = document.createElement("pre");
            body.className = "message-body";
            body.textContent = bodyText;
            div.appendChild(body);

            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }



        function showCopyIndicator() {
            copyIndicator.classList.add("show");
            setTimeout(() => {
                copyIndicator.classList.remove("show");
            }, 2000);
        }

        function connectWebSocket() {
            const address = addressInput.value || "localhost";
            const port = portInput.value || 8080;
            ws = new WebSocket(`ws://${address}:${port}/`);

            ws.onopen = () => {
                logMessage("WebSocket connection established.", "outgoing");
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                ws.send(JSON.stringify({
                    request: "Subscribe",
                    events: { twitch: ["*"] },
                    id: "Poggers"
                }));
                logMessage("Subscribed to Twitch events.", "outgoing");
            };

            ws.onmessage = (event) => {
                logMessage(event.data, "incoming");
            };

            ws.onerror = () => {
                logMessage("Error", "error");
            };

            ws.onclose = () => {
                logMessage("WebSocket connection closed.", "error");
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            };


        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        function downloadLog() {
            const blob = new Blob(eventLog, { type: "text/plain" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "events_log.txt";
            a.click();
        }

        connectBtn.addEventListener("click", () => {
            if (!ws || ws.readyState === WebSocket.CLOSED) {
                connectWebSocket();
            }
        });

        disconnectBtn.addEventListener("click", disconnectWebSocket);
        downloadLogBtn.addEventListener("click", downloadLog);

        window.onload = () => {
            connectWebSocket();
        };
    </script>
</body>

</html>
